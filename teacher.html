<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartTrack ‚Äì Teacher Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --card-soft: #020617;
      --accent: #6366f1;
      --accent-2: #22c55e;
      --accent-soft: rgba(99, 102, 241, 0.18);
      --border: #1f2937;
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --radius-xl: 18px;
      --radius-full: 999px;
      --shadow-soft: 0 22px 45px rgba(15, 23, 42, 0.92);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px 16px 32px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: conic-gradient(from 210deg, #4f46e5, #22c55e, #06b6d4, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 14px 30px rgba(79, 70, 229, 0.8);
    }

    .brand-logo-inner {
      width: 23px;
      height: 23px;
      border-radius: 9px;
      background: radial-gradient(circle at 20% 0%, #e5e7eb 0, #020617 60%, #020617 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .brand-text-title {
      font-size: 18px;
      font-weight: 650;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 6px 11px;
      border-radius: var(--radius-full);
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--muted);
      font-size: 11px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #22c55e 0, #16a34a 60%, #15803d 100%);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .btn-ghost {
      padding: 7px 14px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
    }

    .btn-ghost span {
      font-size: 14px;
      opacity: 0.9;
    }

    .btn-ghost:hover {
      border-color: rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 1);
      transform: translateY(-0.5px);
    }

    @media (max-width: 720px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* Layout */
    .teacher-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.55fr) minmax(0, 1.15fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .teacher-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .column {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* Cards */
    .card {
      border-radius: var(--radius-xl);
      padding: 14px 14px 12px;
      background: radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.2) 0, rgba(15, 23, 42, 0.98) 48%);
      border: 1px solid rgba(55, 65, 81, 0.95);
      box-shadow: var(--shadow-soft);
    }

    .card-soft {
      border-radius: var(--radius-xl);
      padding: 12px 12px 10px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(31, 41, 55, 0.95);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.8);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .chip {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      white-space: nowrap;
    }

    .chip-soft {
      border-color: rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
    }

    /* Current class header card */
    .class-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    .class-meta-item {
      padding: 5px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(55, 65, 81, 0.95);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .class-meta-item strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    .class-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
      margin-top: 6px;
    }

    .class-title-block {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .class-main-label {
      font-size: 16px;
      font-weight: 600;
    }

    .class-main-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .btn-snapshot {
      padding: 8px 14px;
      border-radius: var(--radius-full);
      border: none;
      background: linear-gradient(135deg, #4f46e5, #22c55e);
      color: #f9fafb;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      box-shadow: 0 18px 30px rgba(79, 70, 229, 0.7);
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .btn-snapshot span {
      font-size: 14px;
    }

    .btn-snapshot:hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 40px rgba(79, 70, 229, 0.85);
    }

    @media (max-width: 520px) {
      .class-top-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .btn-snapshot {
        width: 100%;
        justify-content: center;
      }
    }

    /* Roster table */
    .table-wrapper {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      overflow: hidden;
      background: radial-gradient(circle at 0 0, rgba(30, 64, 175, 0.28) 0, rgba(15, 23, 42, 0.98) 48%);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: rgba(15, 23, 42, 0.98);
    }

    th,
    td {
      padding: 7px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.94);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.99);
    }

    .status-select {
      width: 100%;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      font-size: 11px;
      outline: none;
    }

    .roster-footer {
      padding: 7px 10px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .roster-footer strong {
      color: #e5e7eb;
    }

    /* Manage students */
    .fields-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .field {
      flex: 1 1 120px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .field label {
      color: var(--muted);
    }

    .field input {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: 12px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .field input::placeholder {
      color: #4b5563;
    }

    .field input:focus {
      border-color: rgba(129, 140, 248, 0.95);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
      background: rgba(15, 23, 42, 1);
    }

    .btn-small {
      margin-top: 8px;
      padding: 7px 11px;
      border-radius: var(--radius-full);
      border: none;
      background: rgba(15, 23, 42, 1);
      color: #e5e7eb;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(75, 85, 99, 0.95);
      transition: all 0.15s ease;
    }

    .btn-small span {
      font-size: 13px;
    }

    .btn-small:hover {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.9);
      transform: translateY(-0.5px);
    }

    .students-list {
      margin-top: 10px;
      max-height: 240px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: rgba(15, 23, 42, 0.98);
      font-size: 12px;
    }

    .students-row {
      padding: 6px 9px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.95);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      color: #e5e7eb;
    }

    .students-row:last-child {
      border-bottom: none;
    }

    .students-row span.meta {
      color: var(--muted);
      font-size: 11px;
    }

    /* Sessions */
    .sessions-list {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: rgba(15, 23, 42, 0.98);
      max-height: 260px;
      overflow: auto;
      font-size: 12px;
    }

    .session-row {
      padding: 7px 9px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.95);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }

    .session-row:last-child {
      border-bottom: none;
    }

    .session-main {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .session-main-title {
      font-weight: 500;
    }

    .session-main-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .session-extra {
      font-size: 11px;
      color: #9ca3af;
    }

    .session-row:hover {
      background: rgba(17, 24, 39, 0.96);
    }

    .sessions-empty {
      padding: 10px;
      font-size: 11px;
      color: var(--muted);
    }

    .subcard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
    }

    .subcard-header strong {
      color: #e5e7eb;
      font-size: 12px;
    }

    .tag-pill {
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.95);
      background: rgba(15, 23, 42, 0.9);
      font-size: 10px;
      color: var(--muted);
    }

    .footer {
      margin-top: 4px;
      font-size: 10px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .footer a {
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .profile-hint {
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="brand">
        <div class="brand-logo">
          <div class="brand-logo-inner">ST</div>
        </div>
        <div>
          <div class="brand-text-title">SmartTrack AI</div>
          <div class="brand-text-sub">Teacher dashboard ¬∑ Live attendance</div>
        </div>
      </div>
      <div class="header-actions">
        <div class="pill">
          <span class="pill-dot"></span>
          Current session not yet saved
        </div>
        <a href="landing.html" class="btn-ghost">
          Landing
          <span>‚Üó</span>
        </a>
        <a href="login.html" class="btn-ghost">
          Login
          <span>‚Üí</span>
        </a>
      </div>
    </header>

    <main class="teacher-layout">
      <!-- LEFT COLUMN: subject + roster -->
      <section class="column">
        <!-- Class details card -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-subtitle">
                Fill in the details and mark each student. Then use ‚ÄúQuick save snapshot‚Äù.
              </div>
            </div>
            <div class="chip-soft">
              <span>‚ö°</span>
              Snapshot feeds sessions & history
            </div>
          </div>

          <div class="class-top-row">
            <div class="class-title-block">
              <div class="class-main-label" id="class-title-text">Class</div>
              <div class="class-main-sub" id="class-subtitle-text">
                Section AIML-C ¬∑ Today
              </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
              <button class="btn-snapshot" id="save-session-btn">
                Quick save snapshot
                <span>‚ñ¢</span>
              </button>
              <button class="btn-small" id="save-teacher-profile-btn" style="margin-top:4px;">
                Save teacher profile
                <span>üíæ</span>
              </button>
              <div class="profile-hint">
                Saves your name, subject, section & default date.
              </div>
            </div>
          </div>

          <div class="class-meta">
            <div class="class-meta-item">
              <span>üë©‚Äçüè´</span>
              <span>
                <strong>Teacher:</strong>
                <input
                  id="teacher-input"
                  type="text"
                  placeholder="Your name"
                  style="background: transparent; border: none; color: #e5e7eb; font-size: 11px; outline: none; width: 120px;"
                />
              </span>
            </div>
            <div class="class-meta-item">
              <span>üìò</span>
              <span>
                <strong>Subject:</strong>
                <input
                  id="subject-input"
                  type="text"
                  placeholder="Subject"
                  style="background: transparent; border: none; color: #e5e7eb; font-size: 11px; outline: none; width: 120px;"
                />
              </span>
            </div>
            <div class="class-meta-item">
              <span>üè∑Ô∏è</span>
              <span>
                <strong>Section:</strong>
                <input
                  id="section-input"
                  type="text"
                  placeholder="AIML-C"
                  style="background: transparent; border: none; color: #e5e7eb; font-size: 11px; outline: none; width: 90px;"
                />
              </span>
            </div>
            <div class="class-meta-item">
              <span>üìÖ</span>
              <span>
                <strong>Date:</strong>
                <input
                  id="date-input"
                  type="date"
                  style="background: transparent; border: none; color: #e5e7eb; font-size: 11px; outline: none;"
                />
              </span>
            </div>
          </div>
        </section>

        <!-- Roster card -->
        <section class="card-soft">
          <div class="card-header">
            <div>
              <div class="card-subtitle">
                Adjust status per row before saving. New students will auto‚Äëcreate in the database.
              </div>
            </div>
            <div class="chip">
              <span>üéØ</span>
              Mark Present ¬∑ Absent ¬∑ Late
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th style="width: 10%;">Roll</th>
                  <th style="width: 30%;">Name</th>
                  <th style="width: 25%;">Email</th>
                  <th style="width: 15%;">Section</th>
                  <th style="width: 20%;">Status</th>
                </tr>
              </thead>
              <tbody id="roster-body">
                <!-- Rows are dynamically managed in JS -->
              </tbody>
            </table>
            <div class="roster-footer">
              <span><strong id="roster-count">0</strong> students in this view</span>
              <span>Use ‚ÄúManage students‚Äù to fetch by section quickly.</span>
            </div>
          </div>
        </section>
      </section>

      <!-- RIGHT COLUMN: manage students + sessions -->
      <section class="column">
        <!-- Manage students -->
        <section class="card-soft">
          <div class="card-header">
            <div>
              <div class="card-subtitle">
                Add students or load a full section roster. Email is used for login; photo will be set later by the student.
              </div>
            </div>
            <div class="chip-soft">
              <span>üë•</span>
              Students table
            </div>
          </div>

          <div class="fields-row">
            <div class="field">
              <label for="student-name-input">Name</label>
              <input id="student-name-input" type="text" placeholder="e.g., Sana" />
            </div>
            <div class="field">
              <label for="student-roll-input">Roll number</label>
              <input id="student-roll-input" type="text" placeholder="e.g., 21" />
            </div>
          </div>
          <div class="fields-row">
            <div class="field">
              <label for="student-email-input">Email</label>
              <input id="student-email-input" type="email" placeholder="e.g., student21@college.edu" />
            </div>
            <div class="field">
              <label for="student-section-input">Section</label>
              <input id="student-section-input" type="text" placeholder="e.g., AIML-C" />
            </div>
          </div>
          <button class="btn-small" id="add-student-btn">
            Add student (with email)
            <span>Ôºã</span>
          </button>

          <div class="subcard-header">
            <span><strong>Section list</strong> ¬∑ Students from a section</span>
            <span class="tag-pill">Uses /api/students?section=‚Ä¶</span>
          </div>

          <div class="fields-row" style="margin-top: 6px;">
            <div class="field">
              <label for="filter-section-input">Section to load</label>
              <input id="filter-section-input" type="text" placeholder="e.g., AIML-C" />
            </div>
            <button class="btn-small" id="load-section-btn" style="align-self: flex-end;">
              Load section roster
              <span>‚Üì</span>
            </button>
          </div>

          <div class="students-list" id="students-list">
            <!-- Filled by JS from /api/students -->
          </div>
        </section>

        <!-- Recent sessions -->
        <section class="card-soft">
          <div class="card-header">
            <div>
              <div class="card-subtitle">
                Click a session to inspect who was present, absent, or late.
              </div>
            </div>
            <div class="chip-soft">
              <span>üìÇ</span>
              Sessions history
            </div>
          </div>

          <div class="sessions-list" id="sessions-list">
            <div class="sessions-empty" id="sessions-empty">
              No sessions yet ‚Äì save a snapshot to see it appear here.
            </div>
          </div>

          <div class="subcard-header">
            <span><strong>Selected session</strong> ¬∑ Details</span>
            <span class="tag-pill">Uses /api/sessions/:id</span>
          </div>

          <div class="students-list" id="session-details">
            <div class="sessions-empty">Select a session above to view its roster.</div>
          </div>
        </section>
      </section>
    </main>

    <footer class="footer">
      <span>SmartTrack AI ¬∑ Teacher view ¬∑ Uses the same /api endpoints you wired in server.js.</span>
      <span>
        <a href="landing.html">Landing</a> ¬∑
        <a href="login.html">Login</a>
      </span>
    </footer>
  </div>

  <script>
    const classTitleText = document.getElementById("class-title-text");
    const classSubtitleText = document.getElementById("class-subtitle-text");

    const teacherInput = document.getElementById("teacher-input");
    const subjectInput = document.getElementById("subject-input");
    const sectionInput = document.getElementById("section-input");
    const dateInput = document.getElementById("date-input");

    const saveTeacherProfileBtn = document.getElementById("save-teacher-profile-btn");

    const rosterBody = document.getElementById("roster-body");
    const rosterCount = document.getElementById("roster-count");
    const saveSessionBtn = document.getElementById("save-session-btn");

    const addStudentBtn = document.getElementById("add-student-btn");
    const loadSectionBtn = document.getElementById("load-section-btn");

    const studentNameInput = document.getElementById("student-name-input");
    const studentRollInput = document.getElementById("student-roll-input");
    const studentEmailInput = document.getElementById("student-email-input");
    const studentSectionInput = document.getElementById("student-section-input");
    const filterSectionInput = document.getElementById("filter-section-input");
    const studentsList = document.getElementById("students-list");

    const sessionsList = document.getElementById("sessions-list");
    const sessionsEmpty = document.getElementById("sessions-empty");
    const sessionDetails = document.getElementById("session-details");

    function todayISO() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function formatNiceDate(iso) {
      if (!iso) return "Today";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleDateString(undefined, {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    }

    function initHeaderDefaults() {
      const today = todayISO();
      dateInput.value = today;
      sectionInput.value = "AIML-C";
      subjectInput.value = "";
      teacherInput.value = "";
      updateHeaderFromInputs();
    }

    function updateHeaderFromInputs() {
      const subject = subjectInput.value.trim() || "Class";
      const section = sectionInput.value.trim() || "AIML-C";
      const d = dateInput.value || todayISO();
      classTitleText.textContent = subject;
      classSubtitleText.textContent = `Section ${section} ¬∑ ${formatNiceDate(d)}`;
    }

    async function loadTeacherProfile() {
      try {
        const res = await fetch("/api/teachers/me");
        if (!res.ok) {
          initHeaderDefaults();
          return;
        }
        const data = await res.json();

        if (data.name) teacherInput.value = data.name;
        if (data.subject) subjectInput.value = data.subject;
        if (data.section) sectionInput.value = data.section;
        if (data.default_date) {
          dateInput.value = data.default_date;
        } else if (!dateInput.value) {
          dateInput.value = todayISO();
        }
        updateHeaderFromInputs();
      } catch (err) {
        console.error("Failed to load teacher profile", err);
        initHeaderDefaults();
      }
    }

    async function saveTeacherProfile() {
      const body = {
        name: teacherInput.value.trim() || "Teacher",
        subject: subjectInput.value.trim() || "Class",
        section: sectionInput.value.trim() || "AIML-C",
        default_date: dateInput.value || todayISO(),
      };

      try {
        const res = await fetch("/api/teachers/me", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          const msg = data.error || "Failed to save teacher profile.";
          alert(msg);
          return;
        }
        alert("Teacher profile saved.");
      } catch (err) {
        console.error(err);
        alert("Failed to save teacher profile (network or server error).");
      }
    }

    function addRosterRow(roll, name, email, section, status = "present") {
      const tr = document.createElement("tr");

      const tdRoll = document.createElement("td");
      tdRoll.textContent = roll;

      const tdName = document.createElement("td");
      tdName.textContent = name;

      const tdEmail = document.createElement("td");
      tdEmail.textContent = email || "";

      const tdSection = document.createElement("td");
      tdSection.textContent = section;

      const tdStatus = document.createElement("td");
      const select = document.createElement("select");
      select.className = "status-select";
      ["present", "absent", "late"].forEach((opt) => {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt[0].toUpperCase() + opt.slice(1);
        if (opt === status) option.selected = true;
        select.appendChild(option);
      });
      tdStatus.appendChild(select);

      tr.appendChild(tdRoll);
      tr.appendChild(tdName);
      tr.appendChild(tdEmail);
      tr.appendChild(tdSection);
      tr.appendChild(tdStatus);

      rosterBody.appendChild(tr);
      updateRosterCount();
    }

    function clearRoster() {
      rosterBody.innerHTML = "";
      updateRosterCount();
    }

    function updateRosterCount() {
      const rows = rosterBody.querySelectorAll("tr");
      rosterCount.textContent = rows.length;
    }

    function buildStudentsPayload() {
      const rows = rosterBody.querySelectorAll("tr");
      const students = [];
      rows.forEach((row) => {
        const cells = row.querySelectorAll("td");
        const roll = cells[0].textContent.trim();
        const name = cells[1].textContent.trim();
        const email = cells[2].textContent.trim();
        const section = cells[3].textContent.trim();
        const statusSelect = cells[4].querySelector("select");
        const status = statusSelect ? statusSelect.value : "present";
        if (!roll || !name || !section) return;
        students.push({
          rollNumber: roll,
          name,
          email: email || null,
          section,
          status,
        });
      });
      return students;
    }

    async function addStudent() {
      const name = studentNameInput.value.trim();
      const rollNumber = studentRollInput.value.trim();
      const email = (studentEmailInput.value || "").trim();
      const section =
        studentSectionInput.value.trim() || sectionInput.value.trim();

      if (!name || !rollNumber || !section) {
        alert("Please fill name, roll, and section.");
        return;
      }

      try {
        const res = await fetch("/api/students", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, rollNumber, email: email || null, section }),
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          const msg = data.error || "Failed to add student.";
          alert(msg);
          return;
        }

        studentNameInput.value = "";
        studentRollInput.value = "";
        studentEmailInput.value = "";

        if (!studentSectionInput.value && sectionInput.value) {
          studentSectionInput.value = sectionInput.value;
        }

        await loadSectionRoster(section);
      } catch (err) {
        console.error(err);
        alert("Failed to add student (network or server error).");
      }
    }

    async function loadSectionRoster(section) {
      const sec =
        section ||
        filterSectionInput.value.trim() ||
        sectionInput.value.trim();
      if (!sec) {
        alert("Please provide a section (e.g., AIML-C).");
        return;
      }

      try {
        const res = await fetch(
          `/api/students?section=${encodeURIComponent(sec)}`
        );
        if (!res.ok) {
          alert("Failed to load students for that section.");
          return;
        }
        const data = await res.json();

        studentsList.innerHTML = "";
        if (!Array.isArray(data) || data.length === 0) {
          studentsList.innerHTML =
            '<div class="sessions-empty">No students found for this section yet.</div>';
        } else {
          data.forEach((s) => {
            const row = document.createElement("div");
            row.className = "students-row";

            const left = document.createElement("div");
            left.innerHTML = `<strong>${s.roll_number}</strong> ¬∑ ${s.name}<br/><span class="meta">${s.section}</span>${s.email ? `<br/><span class="meta">${s.email}</span>` : ""}`;

            const right = document.createElement("div");
            right.style.display = "flex";
            right.style.alignItems = "center";
            right.style.gap = "6px";

            const viewBtn = document.createElement("button");
            viewBtn.textContent = "View profile";
            viewBtn.className = "btn-small";
            viewBtn.style.padding = "4px 8px";
            viewBtn.style.fontSize = "10px";

            viewBtn.addEventListener("click", () => {
              window.open(
                `student.html?roll=${encodeURIComponent(s.roll_number)}`,
                "_blank"
              );
            });

            right.appendChild(viewBtn);

            row.appendChild(left);
            row.appendChild(right);
            studentsList.appendChild(row);
          });
        }

        clearRoster();
        data.forEach((s) => {
          addRosterRow(s.roll_number, s.name, s.email, s.section);
        });

        filterSectionInput.value = sec;
        sectionInput.value = sec;
        updateHeaderFromInputs();
      } catch (err) {
        console.error(err);
        alert("Failed to load section roster.");
      }
    }

    async function loadSessions() {
      try {
        const res = await fetch("/api/sessions");
        if (!res.ok) {
          console.error("Failed to fetch sessions");
          return;
        }
        const data = await res.json();
        renderSessionsList(data);
      } catch (err) {
        console.error(err);
      }
    }

    function renderSessionsList(items) {
      sessionsList.innerHTML = "";
      if (!Array.isArray(items) || items.length === 0) {
        sessionsList.appendChild(sessionsEmpty);
        sessionsEmpty.style.display = "block";
        return;
      }
      sessionsEmpty.style.display = "none";

      items.forEach((session) => {
        const row = document.createElement("div");
        row.className = "session-row";
        row.dataset.id = session.id;

        const main = document.createElement("div");
        main.className = "session-main";

        const left = document.createElement("div");
        left.innerHTML = `<span class="session-main-title">${session.subject}</span><br/><span class="session-main-meta">${session.teacher_name} ¬∑ ${session.section}</span>`;

        const right = document.createElement("div");
        right.innerHTML = `<span class="session-main-meta">${formatNiceDate(
          session.date
        )}</span>`;

        main.appendChild(left);
        main.appendChild(right);

        const extra = document.createElement("div");
        extra.className = "session-extra";
        extra.textContent = `Session #${session.id}`;

        row.appendChild(main);
        row.appendChild(extra);

        row.addEventListener("click", () => {
          loadSessionDetails(session.id);
        });

        sessionsList.appendChild(row);
      });
    }

    async function loadSessionDetails(id) {
      try {
        const res = await fetch(`/api/sessions/${id}`);
        if (!res.ok) {
          alert("Failed to fetch session details.");
          return;
        }
        const data = await res.json();
        renderSessionDetails(data);
      } catch (err) {
        console.error(err);
        alert("Failed to fetch session details.");
      }
    }

    function renderSessionDetails(payload) {
      sessionDetails.innerHTML = "";

      const { session, records } = payload;

      const header = document.createElement("div");
      header.className = "students-row";
      header.innerHTML = `
        <div>
          <strong>${session.subject}</strong><br/>
          <span class="meta">${session.teacher_name} ¬∑ ${session.section}</span>
        </div>
        <div>
          <span class="meta">${formatNiceDate(session.date)}</span>
        </div>
      `;
      sessionDetails.appendChild(header);

      if (!Array.isArray(records) || records.length === 0) {
        const empty = document.createElement("div");
        empty.className = "sessions-empty";
        empty.textContent = "No attendance records stored for this session.";
        sessionDetails.appendChild(empty);
        return;
      }

      records.forEach((r) => {
        const row = document.createElement("div");
        row.className = "students-row";
        row.innerHTML = `
          <div>
            <strong>${r.roll_number}</strong> ¬∑ ${r.name}
          </div>
          <div>
            <span class="meta">${r.status}</span>
          </div>
        `;
        sessionDetails.appendChild(row);
      });
    }

    async function saveSession() {
      const teacherName = teacherInput.value.trim() || "Teacher";
      const subject = subjectInput.value.trim() || "Class";
      const section = sectionInput.value.trim() || "AIML-C";
      const dateIso = dateInput.value || todayISO();

      const students = buildStudentsPayload();
      if (!students.length) {
        const sure = confirm("No students in roster. Save empty session?");
        if (!sure) return;
      }

      const body = {
        teacherName,
        subject,
        section,
        date: dateIso,
        students,
      };

      try {
        const res = await fetch("/api/attendance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          const msg = data.error || "Failed to save attendance.";
          alert(msg);
          return;
        }

        const data = await res.json();
        alert(`Saved session #${data.sessionId || ""}`.trim());
        await loadSessions();
      } catch (err) {
        console.error(err);
        alert("Failed to save attendance (network or server error).");
      }
    }

    function wireEvents() {
      saveSessionBtn.addEventListener("click", saveSession);
      addStudentBtn.addEventListener("click", addStudent);
      loadSectionBtn.addEventListener("click", () => loadSectionRoster());

      teacherInput.addEventListener("input", updateHeaderFromInputs);
      subjectInput.addEventListener("input", updateHeaderFromInputs);
      sectionInput.addEventListener("input", updateHeaderFromInputs);
      dateInput.addEventListener("input", updateHeaderFromInputs);

      saveTeacherProfileBtn.addEventListener("click", saveTeacherProfile);
    }

    function seedDemoRoster() {
      if (rosterBody.children.length > 0) return;
      addRosterRow("20", "Detroit", "detroit@example.com", "AIML-C", "present");
      addRosterRow("21", "Sana", "sana@example.com", "AIML-C", "absent");
      addRosterRow("22", "Rahul", "rahul@example.com", "AIML-C", "late");
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadTeacherProfile();
      wireEvents();
      seedDemoRoster();
      loadSessions();
    });
  </script>
</body>
</html>
