<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Student Dashboard · SmartTrack</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      body {
        background: #0f172a;
        color: #e5e7eb;
        min-height: 100vh;
        display: flex;
      }

      .sidebar {
        width: 260px;
        background: #020617;
        padding: 1.5rem 1rem;
        border-right: 1px solid #1f2937;
      }

      .logo {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 2rem;
        color: #38bdf8;
      }

      .nav-section-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
        margin: 1.5rem 0 0.5rem;
      }

      .nav-item {
        padding: 0.55rem 0.8rem;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        color: #d1d5db;
        cursor: pointer;
      }

      .nav-item.active {
        background: #111827;
        color: #f9fafb;
        border: 1px solid #1d4ed8;
      }

      .nav-item:hover {
        background: #020617;
      }

      .main {
        flex: 1;
        padding: 1.5rem 2rem;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .topbar-left h1 {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
      }

      .topbar-left p {
        font-size: 0.85rem;
        color: #9ca3af;
      }

      .student-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: linear-gradient(135deg, #1d4ed8, #06b6d4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
        overflow: hidden;
        border: none;
        cursor: pointer;
      }

      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none; /* shown via JS when photo_url exists */
      }

      .avatar-initial {
        display: block;
      }

      .avatar:focus {
        outline: 2px solid #38bdf8;
        outline-offset: 2px;
      }

      .student-meta {
        font-size: 0.85rem;
      }

      .student-meta div:first-child {
        color: #e5e7eb;
      }

      .student-meta div:last-child {
        color: #9ca3af;
        font-size: 0.8rem;
      }

      .grid {
        display: grid;
        grid-template-columns: 2fr 1.5fr;
        gap: 1.25rem;
        margin-top: 0.5rem;
      }

      .card {
        background: #020617;
        border-radius: 0.75rem;
        padding: 1rem 1.1rem;
        border: 1px solid #1f2937;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 0.7rem;
      }

      .card-title {
        font-size: 0.95rem;
        font-weight: 500;
      }

      .card-subtitle {
        font-size: 0.75rem;
        color: #6b7280;
      }

      .pill {
        font-size: 0.75rem;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        border: 1px solid #1f2937;
        color: #9ca3af;
      }

      .pill.success {
        border-color: #16a34a33;
        color: #4ade80;
        background: #022c2255;
      }

      .pill.warn {
        border-color: #f9731633;
        color: #fdba74;
        background: #451a0355;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        margin: 0.35rem 0;
      }

      .stat-label {
        color: #9ca3af;
      }

      .stat-value {
        color: #e5e7eb;
        font-weight: 500;
      }

      .progress-track {
        height: 6px;
        border-radius: 999px;
        background: #020617;
        border: 1px solid #111827;
        margin-top: 0.35rem;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        border-radius: inherit;
      }

      .progress-att {
        width: 0%;
        background: linear-gradient(90deg, #22c55e, #4ade80);
      }

      .progress-marks {
        width: 78%;
        background: linear-gradient(90deg, #3b82f6, #38bdf8);
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
        font-size: 0.8rem;
      }

      .table th,
      .table td {
        text-align: left;
        padding: 0.4rem 0.25rem;
      }

      .table th {
        color: #9ca3af;
        font-weight: 500;
        border-bottom: 1px solid #1f2937;
      }

      .table tr + tr td {
        border-top: 1px solid #020617;
      }

      .chip {
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
        border-radius: 999px;
      }

      .chip.good {
        background: #022c22;
        color: #4ade80;
      }

      .chip.low {
        background: #451a03;
        color: #fdba74;
      }

      /* Profile photo upload card */
      .profile-card {
        margin-top: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .profile-card img {
        width: 72px;
        height: 72px;
        border-radius: 999px;
        object-fit: cover;
        border: 1px solid #1f2937;
        background: #020617;
      }

      .profile-card-controls {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        font-size: 0.8rem;
      }

      .profile-card-controls input[type="file"] {
        font-size: 0.8rem;
      }

      .btn-small {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.3rem 0.7rem;
        border-radius: 999px;
        border: 1px solid #374151;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.75rem;
        cursor: pointer;
      }

      .btn-small:hover {
        background: #111827;
      }

      @media (max-width: 900px) {
        body {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
          display: flex;
          flex-wrap: wrap;
          gap: 0.25rem;
        }
        .main {
          padding: 1rem;
        }
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="logo">SmartTrack · Student</div>

      <div class="nav-section-title">Main</div>
      <div class="nav-item active">Overview</div>
      <div class="nav-item">Attendance</div>
      <div class="nav-item">Marks & Exams</div>
      <div class="nav-item">Assignments</div>

      <div class="nav-section-title">Support</div>
      <div class="nav-item">Messages</div>
      <div class="nav-item">Help & FAQ</div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbar-left">
          <h1>Student Dashboard</h1>
          <p id="subtitle">
            Track your attendance, marks, and progress in one place.
          </p>
        </div>
        <div class="student-info">
          <button class="avatar" id="avatar" type="button">
            <img id="avatar-img" alt="Student photo" />
            <span id="avatar-initial" class="avatar-initial">S</span>
          </button>
          <div class="student-meta">
            <div id="student-name">Student Name</div>
            <div id="student-meta-line">
              Roll: -- · Class: --
            </div>
          </div>
        </div>
      </header>

      <!-- Profile photo upload (option 1) -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Profile photo</div>
            <div class="card-subtitle">
              This single photo is used for your profile and face login demo.
            </div>
          </div>
        </div>
        <div class="profile-card">
          <img
            id="photo-preview"
            src="/images/default-avatar.png"
            alt="Profile photo"
          />
          <div class="profile-card-controls">
            <span>Choose a clear front-facing photo.</span>
            <input
              id="photo-input"
              type="file"
              accept="image/*"
            />
            <button class="btn-small" id="save-photo-btn">
              Save photo
            </button>
            <span id="photo-hint" style="color:#9ca3af;">
              If you update this, the system will use the new image for login.
            </span>
          </div>
        </div>
      </section>

      <section class="grid">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Attendance summary</div>
              <div class="card-subtitle">This semester</div>
            </div>
            <span class="pill success" id="attendance-pill">Loading…</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Overall attendance</span>
            <span class="stat-value" id="overall-att">--%</span>
          </div>
          <div class="progress-track">
            <div class="progress-bar progress-att" id="att-bar"></div>
          </div>

          <div class="stat-row">
            <span class="stat-label">Total classes</span>
            <span class="stat-value" id="total-classes">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Attended</span>
            <span class="stat-value" id="attended-classes">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Absent</span>
            <span class="stat-value" id="absent-classes">--</span>
          </div>

          <div class="stat-row" style="margin-top: 0.75rem;">
            <span class="stat-label">Recent classes</span>
            <span
              class="stat-label"
              style="font-size: 0.75rem;"
              id="recent-count"
            >
              --
            </span>
          </div>
          <table class="table" id="recent-classes">
            <thead>
              <tr>
                <th>Date</th>
                <th>Subject</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <!-- filled by JS -->
            </tbody>
          </table>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Marks snapshot</div>
              <div class="card-subtitle">Internal assessments</div>
            </div>
            <span class="pill" id="marks-updated">Static demo</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Average score</span>
            <span class="stat-value" id="avg-score">78%</span>
          </div>
          <div class="progress-track">
            <div class="progress-bar progress-marks" id="marks-bar"></div>
          </div>

          <table class="table" id="marks-table">
            <thead>
              <tr>
                <th>Subject</th>
                <th>Marks</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Maths for ML</td>
                <td>82 / 100</td>
                <td><span class="chip good">Good</span></td>
              </tr>
              <tr>
                <td>Python</td>
                <td>75 / 100</td>
                <td><span class="chip good">Okay</span></td>
              </tr>
              <tr>
                <td>DSA</td>
                <td>69 / 100</td>
                <td><span class="chip low">Needs focus</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      let currentPhotoUrl = null;
      let currentPhotoBase64 = null;

      function getRollFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("roll");
      }

      async function loadStudentDashboard() {
        const roll = getRollFromUrl();

        if (!roll) {
          alert("No roll number in URL. Redirecting to login.");
          window.location.href = "/login";
          return;
        }

        console.log("Loaded student dashboard for roll:", roll);

        const metaLine = document.getElementById("student-meta-line");
        metaLine.textContent = `Roll: ${roll} · Class: loading…`;

        try {
          const res = await fetch(
            `/api/students/${encodeURIComponent(roll)}/history`
          );
          if (!res.ok) {
            throw new Error("Failed to fetch history");
          }
          const data = await res.json();

          const student = data.student;
          const history = Array.isArray(data.history) ? data.history : [];

          // Header: name + section + avatar initial/photo
          const nameEl = document.getElementById("student-name");
          const avatarInitial = document.getElementById("avatar-initial");
          const avatarImg = document.getElementById("avatar-img");

          nameEl.textContent = student.name || "Student";
          avatarInitial.textContent =
            (student.name && student.name.trim()[0]?.toUpperCase()) || "S";

          // Photo: use photo_url if present
          currentPhotoUrl = student.photo_url || null;
          if (currentPhotoUrl) {
            avatarImg.src = currentPhotoUrl;
            avatarImg.style.display = "block";
            avatarInitial.style.display = "none";

            const profilePreview = document.getElementById("photo-preview");
            if (profilePreview) {
              profilePreview.src = currentPhotoUrl;
            }
          } else {
            avatarImg.style.display = "none";
            avatarInitial.style.display = "block";
          }

          const sectionText = student.section
            ? `Section: ${student.section}`
            : "Section: —";
          metaLine.textContent = `Roll: ${student.roll_number} · ${sectionText}`;

          // Attendance summary
          const total = history.length;
          const present = history.filter((h) => h.status === "present").length;
          const absent = total - present;
          const percent = total > 0 ? Math.round((present / total) * 100) : 0;

          document.getElementById("total-classes").textContent = total;
          document.getElementById("attended-classes").textContent = present;
          document.getElementById("absent-classes").textContent = absent;
          document.getElementById("overall-att").textContent = percent + "%";

          const attBar = document.getElementById("att-bar");
          attBar.style.width = percent + "%";

          const pill = document.getElementById("attendance-pill");
          if (percent >= 85) {
            pill.textContent = "Safe zone";
            pill.classList.add("success");
            pill.classList.remove("warn");
          } else if (percent >= 75) {
            pill.textContent = "Borderline";
            pill.classList.add("warn");
            pill.classList.remove("success");
          } else {
            pill.textContent = "At risk";
            pill.classList.add("warn");
            pill.classList.remove("success");
          }

          // Recent classes (last 5)
          const recentBody = document.querySelector(
            "#recent-classes tbody"
          );
          const recentCount = document.getElementById("recent-count");
          recentBody.innerHTML = "";

          const recent = history.slice(-5).reverse(); // last 5, newest first
          recentCount.textContent = `${recent.length} shown`;

          recent.forEach((h) => {
            const tr = document.createElement("tr");

            const dateCell = document.createElement("td");
            const subjectCell = document.createElement("td");
            const statusCell = document.createElement("td");

            const d = new Date(h.date || h.marked_at);
            const dateStr = isNaN(d.getTime())
              ? h.date || "-"
              : d.toLocaleDateString();

            dateCell.textContent = dateStr;
            subjectCell.textContent = h.subject || "-";

            const chip = document.createElement("span");
            chip.classList.add("chip");
            if (h.status === "present") {
              chip.classList.add("good");
              chip.textContent = "Present";
            } else {
              chip.classList.add("low");
              chip.textContent = "Absent";
            }
            statusCell.appendChild(chip);

            tr.appendChild(dateCell);
            tr.appendChild(subjectCell);
            tr.appendChild(statusCell);
            recentBody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          metaLine.textContent = `Roll: ${roll} · Failed to load data`;
          document.getElementById("overall-att").textContent = "--";
          const pill = document.getElementById("attendance-pill");
          pill.textContent = "Error loading";
          pill.classList.remove("success");
          pill.classList.add("warn");
        }
      }

      // Avatar click: open full photo
      document.getElementById("avatar").addEventListener("click", () => {
        if (currentPhotoUrl) {
          window.open(currentPhotoUrl, "_blank");
        } else {
          alert("No photo available for this student yet.");
        }
      });

      // Photo upload logic (option 1)
      const photoInput = document.getElementById("photo-input");
      const photoPreview = document.getElementById("photo-preview");
      const savePhotoBtn = document.getElementById("save-photo-btn");

      if (photoInput && photoPreview && savePhotoBtn) {
        photoInput.addEventListener("change", () => {
          const file = photoInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            currentPhotoBase64 = e.target.result; // data:image/...;base64,...
            photoPreview.src = currentPhotoBase64;

            // Also update top-right avatar preview immediately
            const avatarImg = document.getElementById("avatar-img");
            const avatarInitial = document.getElementById("avatar-initial");
            if (avatarImg && avatarInitial) {
              avatarImg.src = currentPhotoBase64;
              avatarImg.style.display = "block";
              avatarInitial.style.display = "none";
            }
          };
          reader.readAsDataURL(file);
        });

        savePhotoBtn.addEventListener("click", async () => {
          const roll = getRollFromUrl();
          if (!roll) {
            alert("Missing student roll in URL.");
            return;
          }
          if (!currentPhotoBase64) {
            alert("Please choose a photo first.");
            return;
          }

          try {
            const res = await fetch(
              `/api/students/${encodeURIComponent(roll)}/photo`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ photoUrl: currentPhotoBase64 }),
              }
            );

            if (!res.ok) {
              const data = await res.json().catch(() => ({}));
              alert(data.error || "Failed to save photo.");
              return;
            }

            currentPhotoUrl = currentPhotoBase64;
            alert("Profile photo saved.");
          } catch (err) {
            console.error(err);
            alert("Failed to save photo (network or server error).");
          }
        });
      }

      loadStudentDashboard();
    </script>
  </body>
</html>
