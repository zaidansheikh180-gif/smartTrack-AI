<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartTrack Attendance ‚Äì Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --card: rgba(15, 23, 42, 0.9);
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-strong: rgba(34, 197, 94, 0.35);
      --accent-text: #bbf7d0;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --pill-present: rgba(34, 197, 94, 0.18);
      --pill-absent: rgba(248, 113, 113, 0.18);
      --pill-late: rgba(234, 179, 8, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1220 0, #020617 38%, #000 100%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1180px;
      max-height: 720px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), transparent 50%),
        radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.12), transparent 55%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.98));
      box-shadow:
        0 26px 60px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.7);
      display: grid;
      grid-template-columns: 290px minmax(0, 1fr);
      overflow: hidden;
      position: relative;
    }

    .app-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 10% 0%, rgba(56, 189, 248, 0.14), transparent 50%),
        radial-gradient(circle at 90% 100%, rgba(34, 197, 94, 0.1), transparent 45%);
      opacity: 0.9;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    header.app-header {
      grid-column: 1 / -1;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      padding: 10px 18px 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.92));
      backdrop-filter: blur(20px);
      z-index: 1;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 0%, #22c55e, transparent 55%),
        radial-gradient(circle at 70% 110%, #0ea5e9, transparent 60%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 1px rgba(34, 197, 94, 0.55),
        0 0 18px rgba(34, 197, 94, 0.55);
      position: relative;
      overflow: hidden;
    }

    .brand-mark::after {
      content: "";
      position: absolute;
      inset: 5px;
      border-radius: inherit;
      border: 1px solid rgba(15, 23, 42, 0.4);
      background: radial-gradient(circle at 30% 0%, rgba(15, 23, 42, 0.2), transparent 60%);
    }

    .brand-initial {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #ecfeff;
      position: relative;
      z-index: 1;
      text-shadow: 0 0 10px rgba(15, 23, 42, 0.9);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #e5f9ff;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5f9ff;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow:
        0 0 0 4px rgba(34, 197, 94, 0.18),
        0 0 18px rgba(34, 197, 94, 0.75);
    }

    .status-text {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #bbf7d0;
    }

    .avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: #ecfeff;
      box-shadow:
        0 0 0 2px rgba(15, 23, 42, 0.9),
        0 0 12px rgba(15, 23, 42, 0.9);
    }

    main {
      display: contents;
    }

    aside.panel {
      padding: 14px 14px 14px 16px;
      border-right: 1px solid rgba(148, 163, 184, 0.3);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.98));
      backdrop-filter: blur(22px);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.18), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(34, 197, 94, 0.12), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .panel-header {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .panel-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5f9ff;
    }

    .panel-tag {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
    }

    .panel-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .class-meta {
      position: relative;
      z-index: 1;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(2, 6, 23, 0.96));
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.85);
    }

    .class-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .class-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .class-title {
      font-size: 13px;
      font-weight: 600;
      color: #e5f9ff;
    }

    .class-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .class-pill-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .class-pill {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      color: #e5f9ff;
      background: rgba(15, 23, 42, 0.9);
    }

    .glow-orbit {
      position: absolute;
      right: -12px;
      top: -6px;
      width: 80px;
      height: 80px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.4);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.95),
        0 0 35px rgba(56, 189, 248, 0.4);
      opacity: 0.4;
      transform: rotate(-12deg);
    }

    .info-line {
      position: relative;
      z-index: 1;
      display: flex;
      gap: 8px;
      align-items: flex-start;
      font-size: 11px;
      color: var(--text-muted);
    }

    .info-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
      margin-top: 3px;
    }

    .info-text {
      flex: 1;
    }

    .input-grid {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex: 1;
    }

    .field-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .field-input {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .field-input:focus {
      border-color: var(--accent);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 0 14px rgba(34, 197, 94, 0.4);
      background: rgba(15, 23, 42, 0.98);
    }

    .date-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.92);
    }

    .button-row {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      font-size: 12px;
      padding: 7px 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
     transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: radial-gradient(circle at 30% 0%, #22c55e, #166534);
      color: #ecfdf5;
      box-shadow:
        0 10px 25px rgba(22, 163, 74, 0.65),
        0 0 0 1px rgba(15, 23, 42, 1);
      border: 1px solid rgba(74, 222, 128, 0.7);
    }

    .btn-primary:hover {
      transform: translateY(-0.5px);
      box-shadow:
        0 12px 28px rgba(22, 163, 74, 0.75),
        0 0 0 1px rgba(15, 23, 42, 1);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.8);
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 1);
      border-color: rgba(148, 163, 184, 0.95);
      transform: translateY(-0.5px);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    .btn-outline:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.9);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.9);
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
    }

    .btn-icon {
      font-size: 14px;
    }

    .shortcut-hint {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .keycap {
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 1px 5px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
    }

    .recent-box {
      position: relative;
      z-index: 1;
      margin-top: 10px;
      padding: 8px 9px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(2, 6, 23, 0.98));
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .recent-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .recent-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .recent-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text-main);
    }

    .recent-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 150px;
      overflow: auto;
      padding-right: 2px;
    }

    .recent-item {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(30, 64, 175, 0.6);
      align-items: center;
    }

    .recent-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .recent-line1 {
      font-size: 11px;
      color: #e5f9ff;
    }

    .recent-line2 {
      font-size: 10px;
      color: var(--text-muted);
    }

    .recent-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .recent-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-muted);
      white-space: nowrap;
    }

    section.main-pane {
      padding: 14px 16px 16px 14px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .main-pane::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 100% 0%, rgba(59, 130, 246, 0.2), transparent 55%),
        radial-gradient(circle at 100% 60%, rgba(34, 197, 94, 0.1), transparent 65%);
      opacity: 0.9;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .main-header {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .main-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .main-title {
      font-size: 15px;
      font-weight: 600;
      color: #e5f9ff;
    }

    .main-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .main-metrics {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .metric-pill {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
    }

    .metric-pill strong {
      color: var(--accent-text);
      font-weight: 600;
      margin-right: 4px;
    }

    .table-shell {
      position: relative;
      z-index: 1;
      margin-top: 2px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: linear-gradient(150deg, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      box-shadow:
        0 18px 38px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 520px;
    }

    .table-header {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
    }

    .table-header-title {
      font-size: 12px;
      font-weight: 500;
      color: #e5f9ff;
    }

    .table-header-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .table-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-muted);
    }

    .table-scroll {
      overflow: auto;
      flex: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 100%;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
    }

    th,
    td {
      padding: 7px 8px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.65);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      font-weight: 500;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.96);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.92);
    }

    tbody tr:hover {
      background: rgba(15, 23, 42, 0.98);
    }

    .status-select {
      font-size: 11px;
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      outline: none;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
    }

    .status-pill.present {
      background: var(--pill-present);
      border-color: rgba(34, 197, 94, 0.6);
      color: #bbf7d0;
    }

    .status-pill.absent {
      background: var(--pill-absent);
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    .status-pill.late {
      background: var(--pill-late);
      border-color: rgba(234, 179, 8, 0.7);
      color: #fef3c7;
    }

    .status-dot-pill {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: currentColor;
    }

    .empty-state {
      padding: 18px 14px;
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.78);
      backdrop-filter: blur(12px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 780px;
      max-height: 80vh;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.15), transparent 50%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      box-shadow:
        0 26px 70px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .modal-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
      color: #e5f9ff;
    }

    .modal-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .modal-meta-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .modal-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
    }

    .modal-body {
      padding: 10px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    .modal-table-shell {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.98);
      overflow: hidden;
      max-height: 52vh;
      display: flex;
      flex-direction: column;
    }

    .modal-table-scroll {
      overflow: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 8px 12px 10px;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge-present {
      color: #bbf7d0;
    }

    .badge-absent {
      color: #fecaca;
    }

    .badge-late {
      color: #fef3c7;
    }

    .manage-panel-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: stretch;
      justify-content: flex-end;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      z-index: 35;
    }

    .manage-panel-backdrop.visible {
      display: flex;
    }

    .manage-panel {
      width: 360px;
      max-width: 100%;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      border-left: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow:
        -18px 0 40px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
    }

    .manage-header {
      padding: 10px 12px 8px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .manage-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .manage-title {
      font-size: 13px;
      font-weight: 600;
      color: #e5f9ff;
    }

    .manage-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .manage-body {
      padding: 9px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    .manage-form {
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.98);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .manage-form-row {
      display: flex;
      gap: 6px;
    }

    .manage-list-shell {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.98);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-height: 50vh;
    }

    .manage-list-header {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .manage-list-scroll {
      overflow: auto;
      flex: 1;
    }

    .manage-list-empty {
      padding: 12px 10px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    .manage-student-row {
      padding: 5px 8px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.5);
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .manage-student-main {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .manage-student-line1 {
      color: #e5f9ff;
    }

    .manage-student-line2 {
      color: var(--text-muted);
      font-size: 10px;
    }

    .manage-count-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    @media (max-width: 960px) {
      body {
        padding: 8px;
      }

      .app-shell {
        grid-template-columns: 1fr;
        max-height: none;
      }

      aside.panel {
        display: none;
      }

      header.app-header {
        padding-inline: 12px;
      }

      .table-shell {
        max-height: none;
      }
    }

    @media (max-width: 640px) {
      header.app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .main-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .modal {
        max-width: 100%;
        margin-inline: 8px;
      }

      .manage-panel {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <div class="brand-mark">
          <span class="brand-initial">ST</span>
        </div>
        <div class="brand-text">
          <div class="brand-title">SmartTrack</div>
          <div class="brand-sub">
            AI‚Äëassisted attendance tracker
            <span class="pill">Demo snapshot</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <div class="status-dot"></div>
        <div class="status-text">Backend connected</div>
        <div class="avatar">F</div>
      </div>
    </header>

    <main>
      <aside class="panel">
        <div class="panel-header">
          <div class="panel-title-row">
            <div class="panel-title">Current class</div>
            <div class="panel-tag">AIML ¬∑ Bangalore</div>
          </div>
          <div class="panel-subtitle">
            Configure the session then mark attendance in one view.
          </div>
        </div>

        <div class="class-meta">
          <div class="class-line">
            <div class="class-main">
              <div class="class-title" id="class-title-label">Python ‚Äì AIML‚ÄëC</div>
              <div class="class-sub" id="class-sub-label">SmartTrack snapshot for demo.</div>
            </div>
            <div class="glow-orbit"></div>
          </div>
          <div class="class-pill-row">
            <span class="class-pill" id="class-teacher-pill">Teacher: Unknown</span>
            <span class="class-pill" id="class-section-pill">Section: aiml‚Äëc</span>
          </div>
        </div>

        <div class="info-line">
          <div class="info-dot"></div>
          <div class="info-text">
            Use the panel below to set teacher, subject and section, then load the roster and mark Present / Absent / Late.
          </div>
        </div>

        <div class="input-grid">
          <div class="field-row">
            <div class="field">
              <label class="field-label" for="teacherName">Teacher</label>
              <input id="teacherName" class="field-input" placeholder="e.g. John Doe" />
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label class="field-label" for="subject">Subject</label>
              <input id="subject" class="field-input" placeholder="e.g. Python" value="python" />
            </div>
            <div class="field">
              <label class="field-label" for="section">Section</label>
              <input id="section" class="field-input" placeholder="e.g. aiml-c" value="aiml-c" />
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label class="field-label" for="date">Date</label>
              <input id="date" type="date" class="field-input" />
            </div>
            <div class="field">
              <label class="field-label">Snapshot</label>
              <div id="snapshotLabel" class="date-pill">No session yet</div>
            </div>
          </div>
        </div>

        <div class="button-row">
          <button id="loadStudentsBtn" class="btn btn-secondary">
            <span class="btn-icon">üì•</span>
            Load students for this section
          </button>
          <button id="saveSnapshotBtn" class="btn btn-primary">
            <span class="btn-icon">üíæ</span>
            Quick save snapshot
          </button>
          <div class="shortcut-hint">
            <span class="keycap">Ctrl</span> + <span class="keycap">S</span> to save quickly
          </div>
          <button id="manageStudentsBtn" class="btn btn-ghost">
            <span class="btn-icon">üë•</span>
            Manage students
          </button>
        </div>

        <div class="recent-box">
          <div class="recent-header">
            <div class="recent-title">Recent sessions</div>
            <div class="recent-chip" id="recent-count-label">0 saved</div>
          </div>
          <div id="recentSessionsList" class="recent-list">
            <div class="recent-item">
              <div class="recent-main">
                <div class="recent-line1">No sessions yet</div>
                <div class="recent-line2">Save attendance to see snapshots here.</div>
              </div>
              <div class="recent-right">
                <span class="recent-tag">‚Äî</span>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <section class="main-pane">
        <div class="main-header">
          <div class="main-title-block">
            <div class="main-title">Live roster</div>
            <div class="main-subtitle">
              Mark each student Present, Absent or Late. Saved snapshots show the frozen state later.
            </div>
          </div>
          <div class="main-metrics">
            <div class="metric-pill">
              <strong id="metric-total">0</strong> students
            </div>
            <div class="metric-pill">
              <strong id="metric-present">0</strong> present
            </div>
            <div class="metric-pill">
              <strong id="metric-absent">0</strong> absent
            </div>
            <div class="metric-pill">
              <strong id="metric-late">0</strong> late
            </div>
          </div>
        </div>

        <div class="table-shell">
          <div class="table-header">
            <div>
              <div class="table-header-title">Students in current section</div>
              <div id="table-sub-label" class="table-header-sub">Load students to begin marking.</div>
            </div>
            <div class="table-controls">
              <span class="chip" id="section-chip">Section: ‚Äî</span>
              <span class="chip" id="subject-chip">Subject: ‚Äî</span>
            </div>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width: 48px;">#</th>
                  <th>Name</th>
                  <th>Roll</th>
                  <th>Section</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="studentsTableBody">
                <tr>
                  <td colspan="5">
                    <div class="empty-state">
                      No students loaded yet. Set a section on the left and click ‚ÄúLoad students‚Äù.
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Session details modal -->
  <div id="session-modal-backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title-block">
          <div class="modal-title" id="session-modal-title">Session details</div>
          <div class="modal-subtitle" id="session-modal-subtitle">
            Snapshot of students and statuses.
          </div>
          <div class="modal-meta-row">
            <span class="modal-chip" id="session-modal-id">ID: ‚Äî</span>
            <span class="modal-chip" id="session-modal-subject">Subject: ‚Äî</span>
            <span class="modal-chip" id="session-modal-section">Section: ‚Äî</span>
            <span class="modal-chip" id="session-modal-date">Date: ‚Äî</span>
          </div>
        </div>
        <button id="session-modal-close" class="btn btn-outline">
          ‚úï Close
        </button>
      </div>
      <div class="modal-body">
        <div id="session-analytics-strip" style="display:flex; gap:8px; flex-wrap:wrap; font-size:11px; margin-bottom:6px;">
          <div class="chip" id="session-analytics-total">Total: 0</div>
          <div class="chip" id="session-analytics-present">Present: 0 (0%)</div>
          <div class="chip" id="session-analytics-absent">Absent: 0 (0%)</div>
          <div class="chip" id="session-analytics-late">Late: 0 (0%)</div>
        </div>
        <div class="modal-table-shell">
          <div class="table-header" style="padding:6px 10px;">
            <div class="table-header-title">Students & statuses</div>
            <div class="table-header-sub" id="session-modal-count">
              Loading‚Ä¶
            </div>
          </div>
          <div class="modal-table-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width: 48px;">#</th>
                  <th>Name</th>
                  <th>Roll</th>
                  <th>Section</th>
                  <th>Status</th>
                  <th>Marked at</th>
                </tr>
              </thead>
              <tbody id="session-modal-tbody">
                <tr>
                  <td colspan="6">
                    <div class="empty-state">
                      Loading records‚Ä¶
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div>Session analytics computed from stored attendance.</div>
        <div>
          <span class="badge-present">‚óè Present</span> ¬∑
          <span class="badge-absent">‚óè Absent</span> ¬∑
          <span class="badge-late">‚óè Late</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Student profile & history modal -->
  <div id="student-modal-backdrop" class="modal-backdrop">
    <div class="modal" style="max-width:640px;">
      <div class="modal-header">
        <div class="modal-title-block">
          <div class="modal-title" id="student-modal-title">Student profile</div>
          <div class="modal-subtitle" id="student-modal-subtitle">Attendance history across sessions.</div>
        </div>
        <button id="student-modal-close" class="btn btn-outline">
          ‚úï Close
        </button>
      </div>
      <div class="modal-body" style="gap:10px;">
        <div style="display:flex; gap:10px; align-items:center;">
          <div id="student-modal-avatar" style="width:48px; height:48px; border-radius:999px; background:rgba(15,23,42,0.9); border:1px solid rgba(148,163,184,0.7); display:flex; align-items:center; justify-content:center; overflow:hidden; font-size:20px; font-weight:600;">
            ?
          </div>
          <div style="display:flex; flex-direction:column; gap:2px;">
            <div id="student-modal-name" style="font-size:14px; font-weight:600; color:#e5f9ff;">Name</div>
            <div id="student-modal-meta" style="font-size:11px; color:#9ca3af;">Roll ¬∑ Section</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; font-size:11px;">
              <div class="chip" id="student-modal-total">Sessions: 0</div>
              <div class="chip" id="student-modal-present">Present: 0 (0%)</div>
              <div class="chip" id="student-modal-absent">Absent: 0 (0%)</div>
              <div class="chip" id="student-modal-late">Late: 0 (0%)</div>
            </div>
          </div>
        </div>
        <div class="modal-table-shell">
          <div class="table-header" style="padding:6px 10px;">
            <div class="table-header-title">History</div>
            <div class="table-header-sub" id="student-modal-count">No sessions loaded.</div>
          </div>
          <div class="modal-table-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width:40px;">#</th>
                  <th>Date</th>
                  <th>Subject</th>
                  <th>Section</th>
                  <th>Status</th>
                  <th>Session</th>
                </tr>
              </thead>
              <tbody id="student-modal-tbody">
                <tr>
                  <td colspan="6">
                    <div class="empty-state">No history loaded.</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div>Per-student view built from attendance records.</div>
        <div>
          <span class="badge-present">‚óè Present</span> ¬∑
          <span class="badge-absent">‚óè Absent</span> ¬∑
          <span class="badge-late">‚óè Late</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage students side panel -->
  <div id="manage-panel-backdrop" class="manage-panel-backdrop">
    <div class="manage-panel">
      <div class="manage-header">
        <div class="manage-title-block">
          <div class="manage-title">Manage students</div>
          <div class="manage-subtitle">Add or review students for a section.</div>
        </div>
        <button id="manage-close-btn" class="btn btn-outline">
          ‚úï Close
        </button>
      </div>
      <div class="manage-body">
        <div class="manage-form">
          <div class="manage-form-row">
            <div class="field">
              <label class="field-label" for="manage-section-input">Section</label>
              <input id="manage-section-input" class="field-input" placeholder="e.g. aiml-c" value="aiml-c" />
            </div>
            <div class="field" style="max-width:120px;">
              <label class="field-label">&nbsp;</label>
              <button id="manage-load-btn" class="btn btn-secondary" style="width:100%;">
                Load
              </button>
            </div>
          </div>
          <div class="manage-form-row">
            <div class="field">
              <label class="field-label" for="manage-name-input">Name</label>
              <input id="manage-name-input" class="field-input" placeholder="Student name" />
            </div>
          </div>
          <div class="manage-form-row">
            <div class="field">
              <label class="field-label" for="manage-roll-input">Roll number</label>
              <input id="manage-roll-input" class="field-input" placeholder="e.g. 01" />
            </div>
            <div class="field" style="max-width:120px;">
              <label class="field-label">&nbsp;</label>
              <button id="manage-add-btn" class="btn btn-primary" style="width:100%;">
                Add
              </button>
            </div>
          </div>
        </div>

        <div class="manage-list-shell">
          <div class="manage-list-header">
            <div class="manage-count-label" id="manage-count-label">No students loaded.</div>
          </div>
          <div class="manage-list-scroll" id="manage-list">
            <div class="manage-list-empty">
              Load a section to see students here.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const teacherInput = document.getElementById('teacherName');
    const subjectInput = document.getElementById('subject');
    const sectionInput = document.getElementById('section');
    const dateInput = document.getElementById('date');
    const snapshotLabel = document.getElementById('snapshotLabel');

    const classTitleLabel = document.getElementById('class-title-label');
    const classSubLabel = document.getElementById('class-sub-label');
    const classTeacherPill = document.getElementById('class-teacher-pill');
    const classSectionPill = document.getElementById('class-section-pill');

    const sectionChip = document.getElementById('section-chip');
    const subjectChip = document.getElementById('subject-chip');
    const tableSubLabel = document.getElementById('table-sub-label');
    const studentsTableBody = document.getElementById('studentsTableBody');

    const metricTotal = document.getElementById('metric-total');
    const metricPresent = document.getElementById('metric-present');
    const metricAbsent = document.getElementById('metric-absent');
    const metricLate = document.getElementById('metric-late');

    const loadStudentsBtn = document.getElementById('loadStudentsBtn');
    const saveSnapshotBtn = document.getElementById('saveSnapshotBtn');

    const recentSessionsList = document.getElementById('recentSessionsList');
    const recentCountLabel = document.getElementById('recent-count-label');

    const manageStudentsBtn = document.getElementById('manageStudentsBtn');
    const manageBackdrop = document.getElementById('manage-panel-backdrop');
    const manageCloseBtn = document.getElementById('manage-close-btn');
    const manageSectionInput = document.getElementById('manage-section-input');
    const manageLoadBtn = document.getElementById('manage-load-btn');
    const manageNameInput = document.getElementById('manage-name-input');
    const manageRollInput = document.getElementById('manage-roll-input');
    const manageAddBtn = document.getElementById('manage-add-btn');
    const manageList = document.getElementById('manage-list');
    const manageCountLabel = document.getElementById('manage-count-label');

    const sessionModalBackdrop = document.getElementById('session-modal-backdrop');
    const sessionModalClose = document.getElementById('session-modal-close');

    const studentModalBackdrop = document.getElementById('student-modal-backdrop');
    const studentModalClose = document.getElementById('student-modal-close');

    let currentStudents = [];

    function formatDateForInput(date) {
      const year = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${year}-${m}-${d}`;
    }

    function updateClassHeader() {
      const teacher = teacherInput.value || 'Unknown';
      const subject = subjectInput.value || '‚Äî';
      const section = sectionInput.value || '‚Äî';

      classTitleLabel.textContent = `${subject} ‚Äì ${section}`;
      classSubLabel.textContent = 'SmartTrack snapshot for demo.';
      classTeacherPill.textContent = `Teacher: ${teacher}`;
      classSectionPill.textContent = `Section: ${section}`;

      sectionChip.textContent = `Section: ${section}`;
      subjectChip.textContent = `Subject: ${subject}`;
    }

    function updateMetrics() {
      const total = currentStudents.length;
      let present = 0, absent = 0, late = 0;
      currentStudents.forEach(s => {
        if (s.status === 'Present') present++;
        else if (s.status === 'Absent') absent++;
        else if (s.status === 'Late') late++;
      });
      metricTotal.textContent = total;
      metricPresent.textContent = present;
      metricAbsent.textContent = absent;
      metricLate.textContent = late;
    }

    function renderStudentsTable() {
      if (!studentsTableBody) return;

      if (!currentStudents.length) {
        studentsTableBody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                No students loaded yet. Set a section on the left and click ‚ÄúLoad students‚Äù.
              </div>
            </td>
          </tr>
        `;
        updateMetrics();
        return;
      }

      let rows = '';
      currentStudents.forEach((s, index) => {
        const status = s.status || 'Present';
        let statusClass = 'present';
        if (status === 'Absent') statusClass = 'absent';
        else if (status === 'Late') statusClass = 'late';

        rows += `
          <tr>
            <td>${index + 1}</td>
            <td>${s.name || ''}</td>
            <td>${s.rollNumber || ''}</td>
            <td>${s.section || ''}</td>
            <td>
              <select class="status-select" data-roll="${s.rollNumber}">
                <option value="Present" ${status === 'Present' ? 'selected' : ''}>Present</option>
                <option value="Absent" ${status === 'Absent' ? 'selected' : ''}>Absent</option>
                <option value="Late" ${status === 'Late' ? 'selected' : ''}>Late</option>
              </select>
            </td>
          </tr>
        `;
      });

      studentsTableBody.innerHTML = rows;

      const selects = studentsTableBody.querySelectorAll('.status-select');
      selects.forEach(sel => {
        sel.addEventListener('change', (e) => {
          const roll = sel.getAttribute('data-roll');
          const value = sel.value;
          const student = currentStudents.find(s => s.rollNumber === roll);
          if (student) {
            student.status = value;
          }
          updateMetrics();
        });
      });

      updateMetrics();
    }

    async function loadStudentsForSection() {
      const section = sectionInput.value.trim();
      if (!section) {
        alert('Enter a section first (e.g. aiml-c).');
        return;
      }
      tableSubLabel.textContent = `Loading students for ${section}‚Ä¶`;
      try {
        const res = await fetch(`/api/students?section=${encodeURIComponent(section)}`);
        if (!res.ok) {
          throw new Error('Failed to fetch students from server');
        }
        const rows = await res.json();
        if (!rows.length) {
          currentStudents = [];
          renderStudentsTable();
          tableSubLabel.textContent = `No students found in section ${section}. Use ‚ÄúManage students‚Äù to add them.`;
          return;
        }
        currentStudents = rows.map(r => ({
          name: r.name,
          rollNumber: r.roll_number,
          section: r.section,
          status: 'Present'
        }));
        tableSubLabel.textContent = `Loaded ${currentStudents.length} students for ${section}.`;
        renderStudentsTable();
      } catch (err) {
        console.error(err);
        tableSubLabel.textContent = 'Error loading students.';
        alert('Failed to load students from backend.');
      }
    }

    async function saveSnapshot() {
      if (!currentStudents.length) {
        alert('Load students first before saving a snapshot.');
        return;
      }

      const teacherName = teacherInput.value.trim();
      const subject = subjectInput.value.trim();
      const section = sectionInput.value.trim();
      const date = dateInput.value;

      if (!teacherName || !subject || !section || !date) {
        alert('Fill teacher, subject, section and date before saving.');
        return;
      }

      const payload = {
        teacherName,
        subject,
        section,
        date,
        students: currentStudents.map(s => ({
          name: s.name,
          rollNumber: s.rollNumber,
          status: s.status || 'Present'
        }))
      };

      saveSnapshotBtn.disabled = true;
      saveSnapshotBtn.textContent = 'Saving‚Ä¶';

      try {
        const res = await fetch('/api/attendance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error('Failed to save attendance');
        }

        const data = await res.json();
        const sessionId = data.sessionId;

        snapshotLabel.textContent = `Saved session #${sessionId}`;
        await loadRecentSessions();
      } catch (err) {
        console.error(err);
        alert('Failed to save snapshot.');
      } finally {
        saveSnapshotBtn.disabled = false;
        saveSnapshotBtn.textContent = 'Quick save snapshot';
      }
    }

    async function loadRecentSessions() {
      try {
        const res = await fetch('/api/sessions');
        if (!res.ok) {
          throw new Error('Failed to fetch sessions');
        }

        const sessions = await res.json();
        renderRecentSessions(sessions);
      } catch (err) {
        console.error(err);
        renderRecentSessions([]);
      }
    }

    function renderRecentSessions(sessions) {
      if (!recentSessionsList) return;

      if (!sessions.length) {
        recentSessionsList.innerHTML = `
          <div class="recent-item">
            <div class="recent-main">
              <div class="recent-line1">No sessions yet</div>
              <div class="recent-line2">Save attendance to see snapshots here.</div>
            </div>
            <div class="recent-right">
              <span class="recent-tag">‚Äî</span>
            </div>
          </div>
        `;
        recentCountLabel.textContent = '0 saved';
        return;
      }

      recentCountLabel.textContent = `${sessions.length} saved`;

      let html = '';
      sessions.slice(0, 10).forEach(s => {
        const label = `#${s.id} ¬∑ ${s.subject} ¬∑ ${s.section}`;
        const dateText = s.date || s.created_at;
        html += `
          <div class="recent-item">
            <div class="recent-main">
              <div class="recent-line1">${label}</div>
              <div class="recent-line2">${dateText}</div>
            </div>
            <div class="recent-right">
              <button class="btn btn-outline" data-session-id="${s.id}">
                View
              </button>
            </div>
          </div>
        `;
      });

      recentSessionsList.innerHTML = html;

      const buttons = recentSessionsList.querySelectorAll('button[data-session-id]');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-session-id');
          if (id) {
            openSessionDetails(id);
          }
        });
      });
    }

    function openSessionModal() {
      if (!sessionModalBackdrop) return;
      sessionModalBackdrop.classList.add('visible');
    }

    function closeSessionModal() {
      if (!sessionModalBackdrop) return;
      sessionModalBackdrop.classList.remove('visible');
    }

    async function openSessionDetails(id) {
      const tbody = document.getElementById('session-modal-tbody');
      const countEl = document.getElementById('session-modal-count');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">Loading records‚Ä¶</div>
            </td>
          </tr>
        `;
      }
      if (countEl) countEl.textContent = 'Loading‚Ä¶';

      openSessionModal();

      try {
        const res = await fetch(`/api/sessions/${encodeURIComponent(id)}`);
        if (!res.ok) {
          throw new Error('Failed to fetch session details');
        }
        const data = await res.json();
        renderSessionDetails(data);
      } catch (err) {
        console.error(err);
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">
                <div class="empty-state">Error loading session from server.</div>
              </td>
            </tr>
          `;
        }
        if (countEl) countEl.textContent = 'Error loading session.';
      }
    }

    function renderSessionDetails(sessionData) {
      const { session, records } = sessionData || {};
      const titleEl = document.getElementById('session-modal-title');
      const subtitleEl = document.getElementById('session-modal-subtitle');
      const idEl = document.getElementById('session-modal-id');
      const subjectEl = document.getElementById('session-modal-subject');
      const sectionEl = document.getElementById('session-modal-section');
      const dateEl = document.getElementById('session-modal-date');
      const countEl = document.getElementById('session-modal-count');
      const tbody = document.getElementById('session-modal-tbody');

      const totalChip = document.getElementById('session-analytics-total');
      const presentChip = document.getElementById('session-analytics-present');
      const absentChip = document.getElementById('session-analytics-absent');
      const lateChip = document.getElementById('session-analytics-late');

      if (!session) {
        if (titleEl) titleEl.textContent = 'Session not found';
        if (subtitleEl) subtitleEl.textContent = 'This session could not be loaded.';
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">
                <div class="empty-state">No data available for this session.</div>
              </td>
            </tr>
          `;
        }
        if (totalChip) totalChip.textContent = 'Total: 0';
        if (presentChip) presentChip.textContent = 'Present: 0 (0%)';
        if (absentChip) absentChip.textContent = 'Absent: 0 (0%)';
        if (lateChip) lateChip.textContent = 'Late: 0 (0%)';
        return;
      }

      if (titleEl) titleEl.textContent = `Session #${session.id}`;
      if (subtitleEl) subtitleEl.textContent = `Snapshot for ${session.subject || 'Unknown'} ¬∑ ${session.section || '‚Äî'}`;
      if (idEl) idEl.textContent = `ID: ${session.id}`;
      if (subjectEl) subjectEl.textContent = `Subject: ${session.subject || '‚Äî'}`;
      if (sectionEl) sectionEl.textContent = `Section: ${session.section || '‚Äî'}`;
      if (dateEl) dateEl.textContent = `Date: ${session.date || '‚Äî'}`;

      const total = records?.length || 0;
      let present = 0, absent = 0, late = 0;

      (records || []).forEach((r) => {
        const status = r.status || 'Present';
        if (status === 'Present') present++;
        else if (status === 'Absent') absent++;
        else if (status === 'Late') late++;
      });

      const pct = (count) => total === 0 ? 0 : Math.round((count / total) * 100);

      if (countEl) countEl.textContent = `${total} students saved in this session.`;
      if (totalChip) totalChip.textContent = `Total: ${total}`;
      if (presentChip) presentChip.textContent = `Present: ${present} (${pct(present)}%)`;
      if (absentChip) absentChip.textContent = `Absent: ${absent} (${pct(absent)}%)`;
      if (lateChip) lateChip.textContent = `Late: ${late} (${pct(late)}%)`;

      if (!tbody) return;

      if (!records || records.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">No students were stored for this session.</div>
            </td>
          </tr>
        `;
        return;
      }

      let rows = '';
      records.forEach((r, index) => {
        const name = r.name || 'Student';
        const roll = r.roll_number || r.rollNumber || '';
        const section = r.section || '';
        const status = r.status || 'Present';
        const markedAt = r.marked_at || r.markedAt || '';

        let statusClass = 'present';
        if (status === 'Absent') statusClass = 'absent';
        else if (status === 'Late') statusClass = 'late';

        rows += `
          <tr>
            <td>${index + 1}</td>
            <td>
              <button
                type="button"
                style="background:none;border:none;padding:0;margin:0;color:#bfdbfe;cursor:pointer;text-decoration:underline;font-size:12px;"
                onclick="openStudentProfile('${roll}')"
              >
                ${name}
              </button>
            </td>
            <td>${roll}</td>
            <td>${section}</td>
            <td>
              <span class="status-pill ${statusClass}">
                <span class="status-dot-pill"></span>
                ${status}
              </span>
            </td>
            <td>${markedAt}</td>
          </tr>
        `;
      });

      tbody.innerHTML = rows;
    }

    function openManagePanel() {
      if (!manageBackdrop) return;
      manageBackdrop.classList.add('visible');
    }

    function closeManagePanel() {
      if (!manageBackdrop) return;
      manageBackdrop.classList.remove('visible');
    }

    function setStudentAvatar(el, student) {
      if (!el) return;
      const url = student.photo_url || student.photoUrl;
      if (url) {
        el.innerHTML = '';
        el.style.backgroundImage = `url('${url}')`;
        el.style.backgroundSize = 'cover';
        el.style.backgroundPosition = 'center';
        return;
      }
      const name = student.name || '';
      const initials = name
        .split(' ')
        .filter(Boolean)
        .map(part => part[0]?.toUpperCase())
        .join('')
        .slice(0, 2) || '?';
      el.style.backgroundImage = '';
      el.textContent = initials;
    }

    function openStudentModal() {
      if (!studentModalBackdrop) return;
      studentModalBackdrop.classList.add('visible');
    }

    function closeStudentModal() {
      if (!studentModalBackdrop) return;
      studentModalBackdrop.classList.remove('visible');
    }

    function renderStudentHistory(data) {
      const { student, history } = data || {};

      const titleEl = document.getElementById('student-modal-title');
      const subtitleEl = document.getElementById('student-modal-subtitle');
      const avatarEl = document.getElementById('student-modal-avatar');
      const nameEl = document.getElementById('student-modal-name');
      const metaEl = document.getElementById('student-modal-meta');
      const totalChip = document.getElementById('student-modal-total');
      const presentChip = document.getElementById('student-modal-present');
      const absentChip = document.getElementById('student-modal-absent');
      const lateChip = document.getElementById('student-modal-late');
      const countEl = document.getElementById('student-modal-count');
      const tbody = document.getElementById('student-modal-tbody');

      if (!student) {
        if (titleEl) titleEl.textContent = 'Student not found';
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">
                <div class="empty-state">No history available.</div>
              </td>
            </tr>
          `;
        }
        if (countEl) countEl.textContent = 'No sessions loaded.';
        return;
      }

      if (titleEl) titleEl.textContent = `Profile ¬∑ ${student.name}`;
      if (subtitleEl) subtitleEl.textContent = 'Attendance across all sessions.';
      if (nameEl) nameEl.textContent = student.name || 'Student';
      if (metaEl) metaEl.textContent = `${student.roll_number || ''} ¬∑ ${student.section || ''}`;
      setStudentAvatar(avatarEl, student);

      const total = history?.length || 0;
      let present = 0, absent = 0, late = 0;
      (history || []).forEach((h) => {
        const status = h.status || 'Present';
        if (status === 'Present') present++;
        else if (status === 'Absent') absent++;
        else if (status === 'Late') late++;
      });
      const pct = (c) => total === 0 ? 0 : Math.round((c / total) * 100);

      if (totalChip) totalChip.textContent = `Sessions: ${total}`;
      if (presentChip) presentChip.textContent = `Present: ${present} (${pct(present)}%)`;
      if (absentChip) absentChip.textContent = `Absent: ${absent} (${pct(absent)}%)`;
      if (lateChip) lateChip.textContent = `Late: ${late} (${pct(late)}%)`;
      if (countEl) countEl.textContent = `${total} session(s) in history.`;

      if (!tbody) return;

      if (!history || history.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">No history for this student yet.</div>
            </td>
          </tr>
        `;
        return;
      }

      let rows = '';
      history.forEach((h, idx) => {
        const date = h.date || '';
        const subject = h.subject || '';
        const section = h.section || '';
        const status = h.status || 'Present';
        const sessionId = h.session_id || h.sessionId || '';
        let statusClass = 'present';
        if (status === 'Absent') statusClass = 'absent';
        else if (status === 'Late') statusClass = 'late';

        rows += `
          <tr>
            <td>${idx + 1}</td>
            <td>${date}</td>
            <td>${subject}</td>
            <td>${section}</td>
            <td>
              <span class="status-pill ${statusClass}">
                <span class="status-dot-pill"></span>
                ${status}
              </span>
            </td>
            <td>#${sessionId}</td>
          </tr>
        `;
      });

      tbody.innerHTML = rows;
    }

    async function openStudentProfile(roll) {
      if (!roll) return;

      const tbody = document.getElementById('student-modal-tbody');
      const countEl = document.getElementById('student-modal-count');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">Loading history‚Ä¶</div>
            </td>
          </tr>
        `;
      }
      if (countEl) countEl.textContent = 'Loading‚Ä¶';

      openStudentModal();

      try {
        const res = await fetch(`/api/students/${encodeURIComponent(roll)}/history`);
        if (!res.ok) {
          if (tbody) {
            tbody.innerHTML = `
              <tr>
                <td colspan="6">
                  <div class="empty-state">Failed to load history from server.</div>
                </td>
              </tr>
            `;
          }
          if (countEl) countEl.textContent = 'Error loading history.';
          return;
        }
        const data = await res.json();
        renderStudentHistory(data);
      } catch (err) {
        console.error(err);
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">
                <div class="empty-state">Network error while loading history.</div>
              </td>
            </tr>
          `;
        }
        if (countEl) countEl.textContent = 'Error loading history.';
      }
    }

    async function loadManageList(section) {
      try {
        const res = await fetch(`/api/students?section=${encodeURIComponent(section)}`);
        if (!res.ok) throw new Error('Failed to fetch students');
        const rows = await res.json();

        if (!rows.length) {
          manageList.innerHTML = `
            <div class="manage-list-empty">
              No students found in section ${section}. Add one above.
            </div>
          `;
          manageCountLabel.textContent = '0 students in this section.';
          return;
        }

        let html = '';
        rows.forEach(r => {
          html += `
            <div class="manage-student-row">
              <div class="manage-student-main">
                <div class="manage-student-line1">${r.name}</div>
                <div class="manage-student-line2">${r.roll_number} ¬∑ ${r.section}</div>
              </div>
            </div>
          `;
        });
        manageList.innerHTML = html;
        manageCountLabel.textContent = `${rows.length} student(s) in section ${section}.`;
      } catch (err) {
        console.error(err);
        manageList.innerHTML = `
          <div class="manage-list-empty">
            Error loading students from backend.
          </div>
        `;
        manageCountLabel.textContent = 'Error loading.';
      }
    }

    async function addStudent() {
      const name = manageNameInput.value.trim();
      const roll = manageRollInput.value.trim();
      const section = manageSectionInput.value.trim();

      if (!name || !roll || !section) {
        alert('Fill name, roll and section.');
        return;
      }

      manageAddBtn.disabled = true;
      manageAddBtn.textContent = 'Adding‚Ä¶';

      try {
        const res = await fetch('/api/students', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, rollNumber: roll, section })
        });
        if (res.status === 409) {
          alert('Student already exists in this section.');
        } else if (!res.ok) {
          throw new Error('Failed to add student');
        } else {
          manageNameInput.value = '';
          manageRollInput.value = '';
          await loadManageList(section);
        }
      } catch (err) {
        console.error(err);
        alert('Failed to add student.');
      } finally {
        manageAddBtn.disabled = false;
        manageAddBtn.textContent = 'Add';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      dateInput.value = formatDateForInput(today);
      snapshotLabel.textContent = 'No session yet';

      teacherInput.addEventListener('input', updateClassHeader);
      subjectInput.addEventListener('input', updateClassHeader);
      sectionInput.addEventListener('input', updateClassHeader);

      updateClassHeader();
      loadRecentSessions();

      loadStudentsBtn.addEventListener('click', loadStudentsForSection);
      saveSnapshotBtn.addEventListener('click', saveSnapshot);

      if (sessionModalClose) {
        sessionModalClose.addEventListener('click', closeSessionModal);
      }
      if (sessionModalBackdrop) {
        sessionModalBackdrop.addEventListener('click', (e) => {
          if (e.target === sessionModalBackdrop) {
            closeSessionModal();
          }
        });
      }

      if (studentModalClose) {
        studentModalClose.addEventListener('click', closeStudentModal);
      }
      if (studentModalBackdrop) {
        studentModalBackdrop.addEventListener('click', (e) => {
          if (e.target === studentModalBackdrop) {
            closeStudentModal();
          }
        });
      }

      if (manageStudentsBtn) {
        manageStudentsBtn.addEventListener('click', () => {
          openManagePanel();
          const section = sectionInput.value.trim();
          if (section) {
            manageSectionInput.value = section;
            loadManageList(section);
          }
        });
      }

      if (manageCloseBtn) {
        manageCloseBtn.addEventListener('click', closeManagePanel);
      }
      if (manageBackdrop) {
        manageBackdrop.addEventListener('click', (e) => {
          if (e.target === manageBackdrop) {
            closeManagePanel();
          }
        });
      }

      if (manageLoadBtn) {
        manageLoadBtn.addEventListener('click', () => {
          const section = manageSectionInput.value.trim();
          if (section) loadManageList(section);
        });
      }

      if (manageAddBtn) {
        manageAddBtn.addEventListener('click', addStudent);
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeSessionModal();
          closeManagePanel();
          closeStudentModal();
        }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
          e.preventDefault();
          saveSnapshot();
        }
      });
    });
  </script>
</body>
</html>
